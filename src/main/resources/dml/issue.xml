<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="issue">
<!-- 프로젝트 전체 리스트-->
<select id="selectAllProjectList" resultType="com.toy.project.model.ProjectDto" parameterType="String">
select a.user_id, b.project_id, b.project_name 
from projectmember a
join
  (select project_id, project_name from project
  ) b
on a.project_id = b.project_id
where a.user_id = #{user_id}
</select>

<!-- 프로젝트 이슈 참여자 대상 조회하기 -->
<select id="selectApplyListFromProjectMember" resultType="com.toy.issue.model.projectMemberDto"  parameterType="String">
select a.user_id, b.project_id, b.project_name 
from projectmember a
join
  (select project_id, project_name from project
  ) b
on a.project_id = b.project_id
where a.project_id = #{projectId}
</select>

<!-- 프로젝트에 해당하는 이슈리스트 -->
<select id="selectIssueList" resultType="com.toy.issue.model.IssueDto"  parameterType="String">
select a.issue_id, a.project_id, a.issue_name, a.issue_detail, a.reg_id
from issue a
join project b
on a.project_id = b.project_id
where a.project_id = #{projectId}
</select>

<!-- 이슈생성  -->
<insert id = "insertIssue" parameterType = "com.toy.issue.model.IssueDto">
insert into issue (project_id, issue_detail, issue_name, reg_date, reg_id)
values( 
	#{project_id},
	#{issue_detail},
	#{issue_name},
	now(),
	#{reg_id}
)
</insert>

<!-- 이슈멤버생성  -->
<insert id = "insertIssueMember" parameterType = "com.toy.issue.model.IssueDto">
insert into issuemember (issue_id, user_id, project_id)
values( 
	#{issue_id},
	#{user_id},
	#{project_id}
)
</insert>

<!-- 이슈히스토리에 추가- 상태변경시 -->
<insert id = "insertIssueHistory" parameterType = "com.toy.issue.model.IssueDto">
insert into issuehistory (issue_id, project_id, start_date, end_date, state_code, type, reg_date, reg_id)
values (
	#{issue_id},
	#{project_id},
	#{issue_start_date},
	#{issue_end_date},
	#{state_code},
	#{type},
	now()
	#{reg_id}
)
</insert>

<!-- 이슈멤버 삭제 -->
<delete id = "deleteIssueMember" parameterType = "String">
delete from issuemember
where issue_id = #{issue_id}
</delete>

<!-- 이슈삭제 -->
<delete id = 'deleteIssue' parameterType = 'String'>
delete from issue
where issue_id = #{issue_id}
</delete>


</mapper>